@if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
} @else {
  <div class="overview-dashboard">
    <section class="hero-strip">
      <div class="metric-block primary">
        <span class="metric-label">
          {{ 'home.net_patrimoine' | transloco }}
          <mat-icon
            class="hint-icon"
            [matTooltip]="'hints.net_patrimoine' | transloco"
            matTooltipClass="premium-tooltip"
            >help_outline</mat-icon
          >
        </span>
        <span class="metric-value">{{ formatCurrency(overview()?.netValue ?? 0) }}</span>
      </div>

      <div class="separator"></div>

      <div class="metric-block">
        <span class="metric-label">
          {{ 'home.gross_patrimoine' | transloco }}
          <mat-icon
            class="hint-icon"
            [matTooltip]="'hints.gross_patrimoine' | transloco"
            matTooltipClass="premium-tooltip"
            >help_outline</mat-icon
          >
        </span>
        <span class="metric-value">{{ formatCurrency(overview()?.grossValue ?? 0) }}</span>
      </div>

      <div class="metric-block">
        <span class="metric-label">
          {{ 'home.liabilities' | transloco }}
          <mat-icon class="hint-icon" [matTooltip]="'hints.liabilities' | transloco" matTooltipClass="premium-tooltip"
            >help_outline</mat-icon
          >
        </span>
        <span class="metric-value negative">-{{ formatCurrency(overview()?.liabilities ?? 0) }}</span>
      </div>

      <div class="separator"></div>

      @if (overview()?.performance; as perf) {
        <div class="metric-block" [class.positive]="perf.gainPercent >= 0" [class.negative]="perf.gainPercent < 0">
          <span class="metric-label">
            {{ 'home.performance_12m' | transloco }}
            <mat-icon
              class="hint-icon"
              [matTooltip]="'hints.performance_12m' | transloco"
              matTooltipClass="premium-tooltip"
              >help_outline</mat-icon
            >
          </span>
          <span class="metric-value with-icon">
            <mat-icon>{{ perf.gainPercent >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
            {{ perf.gainPercent >= 0 ? '+' : '' }}{{ perf.gainPercent.toFixed(1) }}%
          </span>
        </div>
      }

      <div class="separator"></div>

      <div class="metric-block" [class]="getDiversificationClass(overview()?.diversificationScore ?? 0)">
        <span class="metric-label">
          {{ 'home.diversification' | transloco }}
          <mat-icon
            class="hint-icon"
            [matTooltip]="'hints.diversification' | transloco"
            matTooltipClass="premium-tooltip"
            >help_outline</mat-icon
          >
        </span>
        <span class="metric-value">{{ overview()?.diversificationScore ?? 0 }}/100</span>
      </div>

      <div class="metric-block" [class]="getRiskClass(overview()?.riskLevel ?? 3)">
        <span class="metric-label">
          {{ 'home.risk_level' | transloco }}
          <mat-icon class="hint-icon" [matTooltip]="'hints.risk_level' | transloco" matTooltipClass="premium-tooltip"
            >help_outline</mat-icon
          >
        </span>
        <span class="metric-value">{{ getRiskLabel(overview()?.riskLevel ?? 3) }}</span>
      </div>

      <button class="ai-analysis-btn" mat-flat-button (click)="launchAiAnalysis()" [disabled]="aiPanelOpen()">
        <mat-icon>auto_awesome</mat-icon>
        <span>{{ 'home.ai_analysis_btn' | transloco }}</span>
      </button>
    </section>

    @if (aiPanelOpen()) {
      <div
        class="ai-panel-overlay"
        role="button"
        tabindex="0"
        (click)="closeAiPanel()"
        (keydown.enter)="closeAiPanel()"
        (keydown.escape)="closeAiPanel()"
      ></div>
      <div class="ai-panel">
        <div class="ai-panel-header">
          <div class="ai-panel-title">
            <mat-icon class="ai-icon">psychology</mat-icon>
            <span>{{ 'home.ai_panel_title' | transloco }}</span>
          </div>
          <button mat-icon-button (click)="closeAiPanel()" [attr.aria-label]="'common.close' | transloco">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="ai-panel-content">
          @if (aiAnalyzing() && !aiContent()) {
            <div class="ai-loading">
              <mat-spinner diameter="32"></mat-spinner>
              <span>{{ 'home.ai_analyzing' | transloco }}</span>
            </div>
          }
          <div class="ai-text markdown-content" [innerHTML]="aiContent() | markdown"></div>
          @if (aiAnalyzing() && aiContent()) {
            <span class="ai-cursor"></span>
          }
        </div>
        @if (aiComplete()) {
          <div class="ai-panel-footer">
            <button mat-stroked-button (click)="closeAiPanel()">
              <mat-icon>check</mat-icon>
              {{ 'home.ai_understood' | transloco }}
            </button>
          </div>
        }
      </div>
    }

    <header class="dashboard-header">
      <div class="header-content">
        <div class="header-icon">
          <mat-icon>dashboard</mat-icon>
        </div>
        <div class="header-text">
          <h1>{{ 'overview.title' | transloco }}</h1>
          <p class="header-subtitle">{{ 'overview.subtitle' | transloco }}</p>
        </div>
      </div>
    </header>

    <div class="dashboard-content">
      <section class="chart-section">
        <div class="chart-container">
          <canvas baseChart type="doughnut" [data]="chartData()" [options]="chartOptions"></canvas>
          <div class="chart-center">
            @if (selectedCategory(); as cat) {
              <span class="center-value" [style.color]="cat.color">{{ formatCurrency(cat.value) }}</span>
              <span class="center-label">{{ cat.label }}</span>
              <span class="center-percent">{{ cat.percent | number: '1.1-1' }}%</span>
            } @else {
              <span class="center-value">{{ formatCurrency(summary().totalValue) }}</span>
              <span class="center-label">{{ 'overview.total_patrimoine' | transloco }}</span>
            }
          </div>
        </div>

        <div class="chart-legend">
          @for (item of summary().breakdown; track item.type) {
            <button
              type="button"
              class="legend-item"
              [class.selected]="selectedCategory()?.type === item.type"
              (click)="onLegendClick(item)"
            >
              <span class="legend-color" [style.background-color]="item.color"></span>
              <span class="legend-label">{{ item.label }}</span>
              <span class="legend-percent">{{ item.percent | number: '1.0-0' }}%</span>
            </button>
          }
        </div>
      </section>

      <aside class="kpi-section">
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-header">
              <mat-icon>diversity_3</mat-icon>
              <span class="kpi-title">
                {{ 'overview.kpi_diversification' | transloco }}
                <mat-icon
                  class="hint-icon"
                  [matTooltip]="'hints.diversification' | transloco"
                  matTooltipClass="premium-tooltip"
                  matTooltipPosition="right"
                  >help_outline</mat-icon
                >
              </span>
            </div>
            <div class="kpi-value">
              <span
                class="kpi-number"
                [class.good]="calculatedDiversificationScore() >= 60"
                [class.warning]="calculatedDiversificationScore() < 40"
              >
                {{ calculatedDiversificationScore() }}/100
              </span>
            </div>
            <div class="kpi-bar">
              <div
                class="kpi-bar-fill"
                [style.width.%]="calculatedDiversificationScore()"
                [class.good]="calculatedDiversificationScore() >= 60"
                [class.warning]="calculatedDiversificationScore() < 40"
              ></div>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-header">
              <mat-icon>pie_chart</mat-icon>
              <span class="kpi-title">
                {{ 'overview.kpi_concentration' | transloco }}
                <mat-icon
                  class="hint-icon"
                  [matTooltip]="'hints.concentration' | transloco"
                  matTooltipClass="premium-tooltip"
                  matTooltipPosition="right"
                  >help_outline</mat-icon
                >
              </span>
            </div>
            <div class="kpi-value">
              <span class="kpi-number" [class.warning]="maxConcentration().percent > 40">
                {{ maxConcentration().percent | number: '1.0-0' }}%
              </span>
            </div>
            <span class="kpi-detail">{{ maxConcentration().category }}</span>
          </div>

          <div class="kpi-card">
            <div class="kpi-header">
              <mat-icon>water_drop</mat-icon>
              <span class="kpi-title">
                {{ 'overview.kpi_liquidity' | transloco }}
                <mat-icon
                  class="hint-icon"
                  [matTooltip]="'hints.liquidity' | transloco"
                  matTooltipClass="premium-tooltip"
                  matTooltipPosition="right"
                  >help_outline</mat-icon
                >
              </span>
            </div>
            <div class="kpi-value">
              <span class="kpi-number" [class.warning]="liquidityRatio() < 15" [class.good]="liquidityRatio() >= 20">
                {{ liquidityRatio() | number: '1.0-0' }}%
              </span>
            </div>
            <span class="kpi-detail">{{ 'overview.kpi_liquidity_detail' | transloco }}</span>
          </div>

          <div class="kpi-card">
            <div class="kpi-header">
              <mat-icon>home</mat-icon>
              <span class="kpi-title">
                {{ 'overview.kpi_real_estate' | transloco }}
                <mat-icon
                  class="hint-icon"
                  [matTooltip]="'hints.real_estate' | transloco"
                  matTooltipClass="premium-tooltip"
                  matTooltipPosition="right"
                  >help_outline</mat-icon
                >
              </span>
            </div>
            <div class="kpi-value">
              <span class="kpi-number">{{ realEstateRatio() | number: '1.0-0' }}%</span>
            </div>
            <span class="kpi-detail">{{ 'overview.kpi_real_estate_detail' | transloco }}</span>
          </div>
        </div>

        @if (alerts().length > 0) {
          <div class="alerts-section">
            <h3 class="alerts-title">
              <mat-icon>lightbulb</mat-icon>
              {{ 'overview.alerts_title' | transloco }}
            </h3>
            <div class="alerts-list">
              @for (alert of alerts(); track alert.titleKey) {
                <div class="alert-card" [class]="alert.type">
                  <mat-icon class="alert-icon">{{ alert.icon }}</mat-icon>
                  <div class="alert-content">
                    <span class="alert-title">{{ alert.titleKey | transloco }}</span>
                    <span class="alert-description">{{
                      alert.descriptionKey | transloco: { value: alert.value }
                    }}</span>
                  </div>
                  @if (alert.value) {
                    <span class="alert-value">{{ alert.value }}</span>
                  }
                </div>
              }
            </div>
          </div>
        }
      </aside>
    </div>
  </div>
}
